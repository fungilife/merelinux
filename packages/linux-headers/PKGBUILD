#!/bin/bash
# shellcheck disable=SC2034,SC2154,SC2068
# Maintainer: Jeremy Huntwork <jeremy@merelinux.org>

rationale='This is part of the core toolchain'
pkgname=linux-headers
pkgver=5.10.60
pkgrel=1
pkgdesc='System headers'
arch=(x86_64)
url='http://www.kernel.org'
license=(GPL2)
groups=(core-dev)
depends=()
makedepends=()
options=()
changelog=ChangeLog
source=(
    "https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-$pkgver.tar.xz"
)

sha256sums=(
    696ff7753f6c7c5123dbcb0a22d693cb358c760c61a76649531b6a207155f78d
)

build() {
    cd_unpacked_src
    make LLVM=1 LLVM_IAS=1 mrproper
    sed -i \
        -e "/rsync/s@rsync@find usr/include -not -type d -name '*.h' | cpio -dump --quiet \$\(INSTALL_HDR_PATH\); true@" \
        -e '/^CC/s@gcc@cc@g' \
        -e '/^HOSTCC/s@gcc@cc@g' Makefile
    make LLVM=1 LLVM_IAS=1 INSTALL_HDR_PATH=dest HOSTCFLAGS="-D_GNU_SOURCE" headers_install
}

package() {
    cd_unpacked_src
    set -o pipefail
    find usr -not -type d -name "*.h" | cpio -dump "${pkgdir}"
}
