#!/bin/bash
# shellcheck disable=SC2034,SC2154,SC2068
# Maintainer: Jeremy Huntwork <jeremy@merelinux.org>

pkgname=linux
pkgver=5.11.7
pkgrel=1
pkgdesc='System kernel'
arch=(x86_64)
url='http://www.kernel.org'
license=(GPL2)
groups=(base)
depends=()
makedepends=(bison flex perl python)
options=()
changelog=ChangeLog
source=(
    "https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-$pkgver.tar.xz"
    linux-config
    busybox-find-compat.patch
)

sha256sums=(
    49b5f12c47e151c98e8dc11a22436940d2d4bf8f5b698ce54d685a24cd3ea8b1
    26e43c82162d5eb0a6095d5762803360101734e4e717b5449359c345fdff77f1
    c8f3271471fd3c9b576fca983511da87f2f9c14dbc1e6eb1573fe98a771b0481
)

build() {
    cd_unpacked_src
    sed -i 's@/usr/bin/awk@/bin/awk@' scripts/ld-version.sh
    # Some internal build scripts expect the GNU find command.
    # Specifically, they expect find will have the -printf flag.
    patch -Np1 -i "${srcdir}/busybox-find-compat.patch"
    cp "${srcdir}/linux-config" .config
    make LLVM=1 LLVM_IAS=1
}

package() {
    cd_unpacked_src
    make LLVM=1 LLVM_IAS=1 INSTALL_MOD_PATH="$pkgdir" modules_install
    install -d "${pkgdir}/boot"
    install "arch/${CARCH}/boot/bzImage" "${pkgdir}/boot/vmlinux"
    install .config "${pkgdir}/boot/config"
    # remove build/source links for now
    rm -f "${pkgdir}/lib/modules/${pkgver}/build" \
          "${pkgdir}/lib/modules/${pkgver}/source"
}
